<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Three.JS: Source Sandbox Hub</title>
<style>
  body { margin:0; overflow:hidden; background:#111; color:#0f0; font-family:monospace;}
  #hud {position:absolute;top:5px;left:5px;z-index:100;color:#0f0;}
  #console {position:absolute;bottom:0;left:0;width:100%;height:120px;background:rgba(0,0,0,0.7);overflow:auto;padding:5px;box-sizing:border-box;}
  #menu {display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:20px;border:2px solid #0f0;}
  #selector {position:absolute;top:5px;right:5px;z-index:100;}
  button {margin:2px;padding:5px;background:#0f0;color:#111;border:none;cursor:pointer;}
</style>
</head>
<body>

<div id="hud">FPS: <span id="fps">0</span></div>
<div id="console"></div>
<div id="menu">PAUSED - PRESS ESC TO RESUME</div>
<div id="selector">
  Three.js: Source 24.53 Beta<br>
  <button onclick="switchScene('renderTest')">Rendering Test</button>
  <button onclick="switchScene('glados')">Blocky GLaDOS</button>
  <button onclick="switchScene('tvGlitch')">TV Glitch</button>
  <button onclick="switchScene('chaos')">Chaos Mode</button>
  <button onclick="switchScene('car')">Car Mode</button>
  <button onclick="switchScene('gmodPlaceholders')">GMod Placeholders</button>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js';

// === Global Variables ===
let renderer, camera, scene, currentScene;
let fpsCounter = document.getElementById('fps');
let consoleDiv = document.getElementById('console');
let menu = document.getElementById('menu');
let clock = new THREE.Clock();
let scenes = {};
let heldObject = null;
let keys = {};
let playerVelocity = new THREE.Vector3();
let canJump = false;
let playerHeight = 1.8;

// === Console ===
function logConsole(msg){
    consoleDiv.innerHTML += msg+'<br>';
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

// === HUD Subtitles ===
let subtitleTimeout;
function showSubtitle(msg){
    clearTimeout(subtitleTimeout);
    let subtitleDiv = document.getElementById('subtitle');
    if(!subtitleDiv){
        subtitleDiv = document.createElement('div');
        subtitleDiv.id = 'subtitle';
        subtitleDiv.style.position = 'absolute';
        subtitleDiv.style.bottom = '50px';
        subtitleDiv.style.width = '100%';
        subtitleDiv.style.textAlign = 'center';
        subtitleDiv.style.color = '#fff';
        subtitleDiv.style.fontFamily = 'monospace';
        subtitleDiv.style.fontSize = '20px';
        subtitleDiv.style.textShadow = '2px 2px 5px #000';
        document.body.appendChild(subtitleDiv);
    }
    subtitleDiv.innerText = msg;
    subtitleTimeout = setTimeout(()=>{subtitleDiv.innerText='';}, 1500);
}

// === Renderer ===
renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// === Player Setup ===
camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.y = playerHeight;
camera.position.z = 5;

// === Basic Scene (Skybox + Floor) ===
scene = new THREE.Scene();
const skyGeo = new THREE.BoxGeometry(500,500,500);
const skyMat = [
  new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}),
  new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}),
  new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}),
  new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}),
  new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}),
  new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}),
];
scene.add(new THREE.Mesh(skyGeo, skyMat));

const floorGeo = new THREE.PlaneGeometry(500,500);
const floorMat = new THREE.MeshStandardMaterial({color:0x444444});
const floor = new THREE.Mesh(floorGeo,floorMat);
floor.rotation.x = -Math.PI/2;
floor.receiveShadow = true;
scene.add(floor);

// === Lights ===
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,7);
scene.add(light);
scene.add(new THREE.AmbientLight(0x404040));

// === Scenes/Mods Placeholders ===
scenes.renderTest = function(){
    let cubeGeo = new THREE.BoxGeometry();
    let cubeMat = new THREE.MeshStandardMaterial({color:0xff00ff, emissive:0x550055});
    for(let i=0;i<10;i++){
        let c = new THREE.Mesh(cubeGeo,cubeMat);
        c.position.set(Math.random()*10-5,1,Math.random()*10-5);
        c.userData.pickable = true;
        scene.add(c);
    }
    logConsole("Rendering Test Started. Emily is probably in trouble...");
};

// === Switch Scenes ===
function switchScene(name){
    // Clear current scene (except floor/light)
    scene.children = scene.children.filter(c=>c===floor||c===light||c.type==='AmbientLight');
    if(scenes[name]) scenes[name]();
    currentScene = name;
}

// === Input Handling ===
document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

document.addEventListener('keydown', e=>{
    if(e.key === 'e'){
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera({x:0,y:0}, camera);
        const intersects = raycaster.intersectObjects(scene.children,true).filter(o=>o.object.userData.pickable);
        if(intersects.length>0){ heldObject = intersects[0].object; logConsole(`Picked up: ${heldObject.name}`);}
        else showSubtitle("Can't Use");
    }
    if(e.key === 'q'){
        let spawnMenu = document.getElementById('spawnMenu');
        if(!spawnMenu){
            spawnMenu = document.createElement('div');
            spawnMenu.id='spawnMenu';
            spawnMenu.style.position='absolute';
            spawnMenu.style.top='100px';
            spawnMenu.style.left='50%';
            spawnMenu.style.transform='translateX(-50%)';
            spawnMenu.style.background='rgba(0,0,0,0.8)';
            spawnMenu.style.padding='10px';
            spawnMenu.style.border='2px solid #0f0';
            document.body.appendChild(spawnMenu);

            const spawnItems = [
                {name:'Cube', geometry:new THREE.BoxGeometry(), material:new THREE.MeshStandardMaterial({color:0xff0})},
                {name:'Sphere', geometry:new THREE.SphereGeometry(0.5,16,16), material:new THREE.MeshStandardMaterial({color:0x0ff})}
            ];
            spawnItems.forEach(item=>{
                const btn = document.createElement('button');
                btn.innerText=item.name;
                btn.onclick=()=>{
                    const mesh = new THREE.Mesh(item.geometry,item.material);
                    mesh.position.copy(camera.position).add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(3));
                    mesh.userData.pickable=true;
                    mesh.name=item.name;
                    scene.add(mesh);
                    logConsole(`Spawned: ${mesh.name}`);
                };
                spawnMenu.appendChild(btn);
            });
        } else spawnMenu.style.display = spawnMenu.style.display==='none'?'block':'none';
    }
    if(e.key==='Escape') menu.style.display = menu.style.display==='none'?'block':'none';
});

// === Animate Loop ===
function animate(){
    requestAnimationFrame(animate);
    let delta = clock.getDelta();

    // FPS
    fpsCounter.innerText = Math.floor(1/delta);

    // Player Movement
    const speed = 5;
    if(keys['w']) camera.position.add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(speed*delta));
    if(keys['s']) camera.position.add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(-speed*delta));
    if(keys['a']) camera.position.add(new THREE.Vector3().crossVectors(camera.up, camera.getWorldDirection(new THREE.Vector3())).normalize().multiplyScalar(speed*delta));
    if(keys['d']) camera.position.add(new THREE.Vector3().crossVectors(camera.getWorldDirection(new THREE.Vector3()), camera.up).normalize().multiplyScalar(speed*delta));
    if(keys[' ']){ // jump
        if(canJump){ playerVelocity.y=5; canJump=false;}
    }

    // Gravity
    playerVelocity.y -= 9.8*delta;
    camera.position.y += playerVelocity.y*delta;
    if(camera.position.y<playerHeight){ camera.position.y=playerHeight; playerVelocity.y=0; canJump=true;}

    // Held object follow
    if(heldObject){
        const holdPos = camera.position.clone().add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(2));
        heldObject.position.lerp(holdPos, 0.2);
    }

    renderer.render(scene,camera);
}

animate();
switchScene('renderTest'); // Start with renderTest

</script>
</body>
</html>
