<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Three.JS: Source 24.53 Beta</title>
<style>
  body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
  #fps { position: absolute; top: 5px; left: 5px; color: #0f0; font-size: 16px; }
  #subtitles { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 20px; }
  #menu { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.8); color: #fff; font-size: 30px; text-align: center; line-height: 100vh; }
  #chat { position: absolute; right: 5px; bottom: 5px; width: 300px; height: 200px; 
          background: rgba(0,0,0,0.5); color: #0f0; font-size: 12px; overflow-y: auto; padding: 5px; }
</style>
</head>
<body>
<div id="fps">FPS: 0</div>
<div id="subtitles"></div>
<div id="menu">PAUSED - PRESS ESC TO RESUME</div>
<div id="chat"></div>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js';

let scene, camera, renderer, clock;
let keys = {};
let heldObject = null;
let fpsCounter = document.getElementById('fps');
let subtitles = document.getElementById('subtitles');
let chat = document.getElementById('chat');
let menu = document.getElementById('menu');
let paused = false;
let cheats = 0;

// Setup scene
scene = new THREE.Scene();

// Skybox placeholder
scene.background = new THREE.Color(0x202040);

// Camera
camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 2, 5);

// Renderer
renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Clock
clock = new THREE.Clock();

// Floor
let floorGeo = new THREE.PlaneGeometry(100, 100);
let floorMat = new THREE.MeshStandardMaterial({color:0x444444});
let floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// Light
let light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10, 10, 10);
scene.add(light);

// Placeholder cubes and spheres
let cubes = [];
let spheres = [];
for(let i=0;i<10;i++){
    let cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:0xff0000}));
    cube.position.set(Math.random()*10-5,0.5,Math.random()*10-5);
    scene.add(cube);
    cubes.push(cube);

    let sphere = new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16), new THREE.MeshStandardMaterial({color:0x00ff00}));
    sphere.position.set(Math.random()*10-5,0.5,Math.random()*10-5);
    scene.add(sphere);
    spheres.push(sphere);
}

// Blocky GLaDOS placeholder
let glados = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({color:0xffff00}));
glados.position.set(0,2,-5);
scene.add(glados);

// Serious Room placeholder
let room = new THREE.Mesh(new THREE.BoxGeometry(20,10,20), new THREE.MeshStandardMaterial({color:0x666666, side: THREE.BackSide}));
room.position.y=5;
scene.add(room);

// Drivable car placeholder
let car = new THREE.Mesh(new THREE.BoxGeometry(2,1,4), new THREE.MeshStandardMaterial({color:0x0000ff}));
car.position.set(5,0.5,0);
scene.add(car);
let drivingCar=false;

// Movement variables
let velocity = new THREE.Vector3();
let speed = 5;
let jumpSpeed = 5;
let gravity = -9.8;
let onGround = true;

// Controls
document.addEventListener('keydown', (e)=>{ keys[e.key.toLowerCase()]=true; if(e.key==='Escape') togglePause(); });
document.addEventListener('keyup', (e)=>{ keys[e.key.toLowerCase()]=false; });
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

function togglePause(){
    paused = !paused;
    menu.style.display = paused?'block':'none';
}

// Interaction
document.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='e'){
        if(!heldObject){
            // Pick nearest object
            let nearest = null;
            let minDist = 2;
            [...cubes,...spheres].forEach(obj=>{
                if(obj.position.distanceTo(camera.position)<minDist){ nearest=obj; minDist=obj.position.distanceTo(camera.position); }
            });
            if(nearest){ heldObject=nearest; addChat(`Picked up object`); subtitles.textContent=''; } 
            else subtitles.textContent="Can't Use";
        } else {
            heldObject=null;
        }
    }
    if(e.key.toLowerCase()==='q'){
        addChat("Spawn Menu opened (placeholder)");
    }
});

// Console cheats placeholder
function runCommand(cmd){
    if(cmd.startsWith("sv_cheats")){
        cheats = parseInt(cmd.split(' ')[1]);
        addChat(`Server char sv_cheats changed to ${cheats}`);
    } else addChat("Unknown command");
}

// Chat helper
function addChat(msg){
    let div = document.createElement('div');
    div.textContent=msg;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// Animation loop
function animate(){
    requestAnimationFrame(animate);
    let dt = clock.getDelta();

    if(!paused){
        // Movement
        let forward=(keys['w']?1:0)+(keys['s']?-1:0);
        let right=(keys['a']?-1:0)+(keys['d']?1:0);
        let dir = new THREE.Vector3();
        camera.getWorldDirection(dir);
        dir.y=0; dir.normalize();
        let rightVec = new THREE.Vector3().crossVectors(camera.up, dir).normalize();

        velocity.x = (dir.x*forward + rightVec.x*right)*speed;
        velocity.z = (dir.z*forward + rightVec.z*right)*speed;

        // Jump
        if(keys[' ']){ if(onGround){ velocity.y=jumpSpeed; onGround=false; } }

        velocity.y += gravity*dt;
        camera.position.addScaledVector(velocity, dt);

        if(camera.position.y<2){ camera.position.y=2; velocity.y=0; onGround=true; }

        // Held object follow camera
        if(heldObject){
            let holdPos = camera.position.clone().add(dir.clone().multiplyScalar(2));
            heldObject.position.lerp(holdPos, 0.2);
        }

        // Car driving
        if(keys['f']) drivingCar=!drivingCar;
        if(drivingCar){
            let forwardCar = keys['w']?0.1:keys['s']?-0.1:0;
            car.position.add(new THREE.Vector3(0,0,forwardCar));
        }

        // Chaos cubes rotation
        cubes.forEach(c=>c.rotation.x+=dt; c.rotation.y+=dt);
        spheres.forEach(s=>s.rotation.y+=dt);

        // FPS
        fpsCounter.textContent=`FPS: ${Math.round(1/dt)}`;
    }

    renderer.render(scene,camera);
}
animate();

</script>
</body>
</html>
